#:import dp kivy.metrics.dp

<MyScreenManager>:
    MainScreen:
    PlaylistScreen:
    UploadScreen:
    AccountScreen:
    ScoreScreen:
    ColorScreen:
    
<MainScreen>:
    name: "main"
    FloatLayout:
        id: root_layout
        BoxLayout:
            orientation: "vertical"
            padding: dp(10)
            spacing: dp(10)
            canvas.before:
                Color:
                    rgba: app.background_color
                Rectangle:
                    pos: self.pos
                    size: self.size
            # Header with app title and toggle theme button.
            BoxLayout:
                size_hint_y: 0.16
                padding: dp(10)
                orientation: 'horizontal'
                # This will push your inner box to the center horizontally
                Widget:
                    size_hint_x: 1
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_x: None
                    width: self.minimum_width
                    spacing: dp(10)
                    Button:
                        text: "Account Info"
                        size_hint_x: None
                        width: dp(120)
                        on_press: root.manager.current = "account"; root.set_username()
                    Button:
                        text: "Choose Theme"
                        size_hint_x: None
                        width: dp(120)
                        on_press: root.manager.current = "color"; root.set_background_rbg()
                    Button:
                        id: togglevideobtn
                        text: "Toggle Video"
                        size_hint_x: None
                        width: dp(120)
                        on_press: root.toggle_video()
                        opacity: 0 if root.is_android else 1
                        disabled: True if root.is_android else False
                Widget:
                    size_hint_x: 1
            BoxLayout:
                size_hint_y: 0.01
                orientation:"vertical"
                Label:
                    text: "Guess That Song"
                    font_size: dp(20)
                    halign: "left"
            # Row for Pitch Slider
            BoxLayout:
                orientation: "vertical"
                spacing: dp(5)
                size_hint_y: 0.16
                Label:
                    id: labelpitch
                    text: root.pitch_text
                Slider:
                    id: sliderA
                    min: -12
                    max: 12
                    value: 0
                    step: 1
                    value_track: True
                    value_track_color: 0.086, 0.094, 0.090, 1 
                    on_value: root.set_label_pitch(self.value)
            # Tempo slider section
            BoxLayout:
                orientation: "vertical"
                spacing: dp(5)
                size_hint_y: 0.16
                Label:
                    id: labeltempo
                    text: root.tempo_text
                Slider:
                    id: slider1
                    min: 0.75
                    max: 1.5
                    value: 1
                    step: 0.05
                    value_track: True
                    value_track_color: 0.086, 0.094, 0.090, 1 
                    on_value: root.set_label_tempo(self.value)
            # Difficulty slider section
            BoxLayout:
                orientation: "vertical"
                spacing: dp(5)
                size_hint_y: 0.16
                Label:
                    id: labellod
                    text: root.lod_text
                Slider:
                    id: slider2
                    min: 0
                    max: 12
                    value: 0
                    step: 1
                    value_track: True
                    value_track_color: 0.086, 0.094, 0.090, 1 
                    on_value: root.set_label_lod(self.value)
            # Dropdown and View Playlist button row
            BoxLayout:
                size_hint_y: 0.1
                spacing: dp(10)
                orientation: "horizontal"
                Spinner:
                    id: dropdown
                    text: "Select Playlist"
                    values: root.get_spinner_values()
                    on_text: if dropdown.text != "Select Playlist": root.toggle_view_playlist()
                Button:
                    id: view_playlist
                    text: "View Playlist"
                    on_press: root.manager.current = "playlist"
                    disabled: root.view_playlist_condition
            # Row of media control buttons.
            BoxLayout:
                orientation: "horizontal"
                size_hint_y: 0.1
                spacing: dp(10)
                Button:
                    id: playbtn
                    text: "Play"
                    on_press: root.play_random_song()
                    disabled: root.view_playlist_condition
                Button:
                    id: pausebtn
                    text: "Pause"
                    disabled: True
                    on_press: root.pause_song()
                Button:
                    id: restartbtn
                    text: "Restart"
                    disabled: True
                    on_press: root.restart_song()
            # TextInput for the guess.
            TextInput:
                id: guess_input
                hint_text: "Place your guess here"
                multiline: False
                size_hint_y: 0.1
            # Submit button to switch to the playlist screen.
            Button:
                id: submitbtn
                text: "Submit"
                disabled: True
                size_hint_y: 0.05
                on_press: root.manager.current = "score"; app.root.get_screen("score").getscore()
        # Video widget as the background
        Video:
            id: bg_video
            source: "background_video.mp4"
            options: {"eos": "loop"}
            volume: 0
            allow_stretch: True
            keep_ratio: False
            size: self.parent.size
            pos: self.parent.pos
            size_hint: 1, 1
            pos_hint: {"x": 0, "y": 0}
            state: "pause"
            opacity: 0

<PlaylistScreen>:
    name: "playlist"
    BoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        padding: dp(10)
        canvas.before:
            Color:
                rgba: app.background_color
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            text: "Playlist"
            font_size: dp(24)
            size_hint_y: None
            height: dp(50)
        RecycleView:
            id: playlist_rv
            viewclass: "SongItem"
            # The RecycleBoxLayout arranges items vertically.
            RecycleBoxLayout:
                default_size: None, dp(40)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: "vertical"
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: "Add New Song"
                size_hint_y: None
                height: dp(50)
                on_press: root.add_song()
            Button:
                text: "Back"
                size_hint_y: None
                height: dp(50)
                on_press: root.manager.current = "main"
        
<UploadScreen>:
    name: "upload"
    BoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        padding: dp(10)
        canvas.before:
            Color:
                rgba: app.background_color
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            text: "Upload Audio File"
            font_size: dp(24)
            size_hint_y: None
            height: dp(50)
        Label:
            id: filechooserlabel
            text: "File Selected: "
            font_size: dp(12)
            size_hint_y: None
            height: dp(25)
        FileChooserListView:
            id: filechooser
            path: '.'
            on_selection: filechooserlabel.text = self.selection and self.selection[0] or ''
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: "Upload Audio File"
                size_hint_y: None
                height: dp(50)
                on_press: root.upload_file()
            Button:
                text: "Back"
                size_hint_y: None
                height: dp(50)
                on_press: root.manager.current = "playlist"

<ColorScreen>:
    name: "color"
    BoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        padding: dp(10)
        canvas.before:
            Color:
                rgba: app.background_color
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            text: "R: " + str(sliderR.value)
            size_hint_y: None
            height: dp(30)
        Slider:
            id: sliderR
            min: 0
            max: 255
            value: 0
            step: 1
            value_track: True
            value_track_color: 0.086, 0.094, 0.090, 1 
        Label:
            text: "G: " + str(sliderG.value)
            size_hint_y: None
            height: dp(30)
        Slider:
            id: sliderG
            min: 0
            max: 255
            value: 0
            step: 1
            value_track: True
            value_track_color: 0.086, 0.094, 0.090, 1 
        Label:
            text: "B: " + str(sliderB.value)
            size_hint_y: None
            height: dp(30)
        Slider:
            id: sliderB
            min: 0
            max: 255
            value: 0
            step: 1
            value_track: True
            value_track_color: 0.086, 0.094, 0.090, 1 
        Label:
            text: "Opacity: " + str(sliderOpacity.value)
            size_hint_y: None
            height: dp(30)
        Slider:
            id: sliderOpacity
            min: 0
            max: 1
            value: 0
            step: 0.01
            value_track: True
            value_track_color: 0.086, 0.094, 0.090, 1 
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: "Apply"
                size_hint_y: None
                height: dp(50)
                # on_press: root.add_song()
                on_press: app.change_theme(sliderR.value, sliderG.value, sliderB.value, sliderOpacity.value)
            Button:
                text: "Back"
                size_hint_y: None
                height: dp(50)
                on_press: root.manager.current = "main"

<AccountScreen>:
    name: "account"
    BoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        padding: dp(10)
        canvas.before:
            Color:
                rgba: app.background_color
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            text: "Account Info"
            font_size: dp(24)
            size_hint_y: None
            height: dp(50)
        ScrollView:
            do_scroll_x: True
            do_scroll_y: True
            BoxLayout:
                orientation: "vertical"
                spacing: dp(10)
                padding: dp(10)
                size_hint_y: None
                size_hint_x: None
                height: self.minimum_height
                width: self.minimum_width
                Label:
                    id: usernamelabel
                    text_size: None, None
                    text: "Username: "
                    font_size: dp(24)
                    size_hint_y: None
                    height: dp(50)
                TextInput:
                    id: usernametext
                    hint_text: "Put your username here"
                    multiline: False
                    size_hint_y: None
                    height: dp(40)
                Label:
                    id: topcorrectsongs
                    text_size: None, None
                    size_hint: None, None
                    size: self.texture_size
                    text: "Top Song(s) Guessed Correctly: "
                    font_size: dp(24)
                    size_hint_y: None
                    height: dp(50)
                Label:
                    id: topincorrectsongs
                    text_size: None, None
                    size_hint: None, None
                    size: self.texture_size
                    text: "Top Song(s) Guessed Incorrectly: "
                    font_size: dp(24)
                    size_hint_y: None
                    height: dp(50)
                Label:
                    id: mostcommonkey
                    text_size: None, None
                    size_hint: None, None
                    size: self.texture_size
                    text: "Most Commonly Used Key Signature(s): "
                    font_size: dp(24)
                    size_hint_y: None
                    height: dp(50)
                Label:
                    id: mostcommontempo
                    text_size: None, None
                    size_hint: None, None
                    size: self.texture_size
                    text: "Most Commonly Used Tempo(s): "
                    font_size: dp(24)
                    size_hint_y: None
                    height: dp(50)
                Label:
                    id: mostcommonlod
                    text_size: None, None
                    size_hint: None, None
                    size: self.texture_size
                    text: "Most Commonly Used Level Of Difficulty(ies): "
                    font_size: dp(24)
                    size_hint_y: None
                    height: dp(50)
                Label:
                    id: averagescoreoverall
                    text_size: None, None
                    size_hint: None, None
                    size: self.texture_size
                    text: "Average Score (Overall): "
                    font_size: dp(24)
                    size_hint_y: None
                    height: dp(50)
        ScrollView:
            do_scroll_x: True
            do_scroll_y: True
            GridLayout:
                id: gridlayouttable
                cols: 10
                size_hint: None, None
                height: self.minimum_height
                width: self.minimum_width * 1.5
                row_default_height: 100
                col_default_width: 200
                Label:
                    text: 'Timestamp'
                    id:  gridtimestamp
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'Tempo'
                    id:  gridtempo
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'Key'
                    id:  gridkey
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'Level Of Difficulty'
                    id:  gridlod
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'Random Song Chosen'
                    id:  gridrsc
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'User Guess'
                    id:  gridug
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'User Score'
                    id:  gridus
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'Correct Guess'
                    id:  gridlcg
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'Song Popularity'
                    id:  gridsp
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
                Label:
                    text: 'Times Played'
                    id:  gridtp
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] + 20  # Padding for visibility
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: "Apply"
                size_hint_y: None
                height: dp(50)
                # on_press: root.add_song()
                on_press: app.change_username(usernametext.text)
            Button:
                text: "Back"
                size_hint_y: None
                height: dp(50)
                on_press: root.manager.current = "main"

<ScoreScreen>:
    name: "score"
    BoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        padding: dp(10)
        canvas.before:
            Color:
                rgba: app.background_color
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            text: "Results"
            font_size: dp(24)
            size_hint_y: None
            height: dp(50)
        ScrollView:
            do_scroll_x: True
            do_scroll_y: False
            Label:
                id: scorelabel
                text_size: None, None
                size_hint: None, None
                size: self.texture_size
                text: "No score available"
                font_size: dp(24)
                size_hint_y: None
                height: dp(50)
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: "Back"
                size_hint_y: None
                height: dp(50)
                # on_press: root.manager.current = "main"
                # on_press: root.restart_app() # Workaround for playing 2+ songs on same run
                on_press: root.manager.current = "main" if root.is_android else root.restart_app()

<PlaylistDeleteScreen>:
    name: "playlistdelete"
    BoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        padding: dp(10)
        canvas.before:
            Color:
                rgba: app.background_color
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            text: "Playlist"
            font_size: dp(24)
            size_hint_y: None
            height: dp(50)
        RecycleView:
            id: playlist_rv
            viewclass: "SongItem"
            # The RecycleBoxLayout arranges items vertically.
            RecycleBoxLayout:
                default_size: None, dp(40)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: "vertical"
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: "Delete Playlist"
                size_hint_y: None
                height: dp(50)
            Button:
                text: "Back"
                size_hint_y: None
                height: dp(50)
                on_press: root.manager.current = "main"

<SongItem>:
    orientation: "horizontal"
    size_hint_y: None
    height: dp(40)
    Label:
        text: root.song_name
        halign: "left"
        valign: "middle"
        text_size: self.size
    Button:
        text: "Delete"
        size_hint_x: None
        width: dp(80)
        on_press: app.root.get_screen('playlist').remove_song(root.song_name)